@option discardLogicWhitespace=true

@import com.codepiano.deduction.tool.*
@import com.codepiano.deduction.models.*
@import java.util.*

@args (Map<String, String> packages, String controllerPackage, String modelName, String variableName, String beanPackage, String errorPackage, String httpPackage)

package @controllerPackage

import (
    "github.com/gin-gonic/gin"
    "net/http"
    "strconv"
    "@(packages.get("service"))"
    "@(packages.get("bean"))"
    "@(packages.get("error"))"
    "@(packages.get("http"))"
)

// 分页获取@(modelName)列表
func (ctl *Controller) Get@(modelName)List(c *gin.Context) {
    param := PaginationParam{}
    if err := c.ShouldBindQuery(&param); err != nil {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    @(variableName)List, count, err := ctl.Service.Get@(modelName)List(param.PageNum, param.PageSize)
    if err != nil {
        c.Error(err)
        return
    }

    c.JSON(http.StatusOK, &@(httpPackage).BaseResp{
        Meta: &@(httpPackage).Meta{
            Code: @(errorPackage).CodeSuccess,
        },
        Data: struct {
            @(modelName)s       []@(beanPackage).@(modelName) `json:"rows"`
            TotalCount int          `json:"total_count"`
        }{
            @(modelName)s:       @(variableName)List,
            TotalCount: count,
        },
    })
}

// 根据 id 获取@(modelName)
func (ctl *Controller) Get@(modelName)ById(c *gin.Context) {
	idString := c.Param("@(variableName)_id")
	if idString == "" {
		c.Error(&rest.Error{Code: rest.RequestParameterInvalid})
		return
	}
	id, err := strconv.ParseUint(idString, 10, 64)
	if err != nil {
		c.Error(&rest.Error{Code: rest.RequestParameterInvalid})
		return
	}
	@(variableName), err := ctl.Service.Get@(modelName)ByID(id, nil)
	if err != nil {
		c.Error(&rest.Error{Code: rest.RequestDataNotExisted})
		return
	}
	c.JSON(http.StatusOK, &rest.BaseResp{
		Meta: &rest.Meta{
			Code: rest.CodeSuccess,
		},
		Data: struct {
			@(modelName) *db.@(modelName) `json:"@(variableName)"`
		}{
			@(modelName): @(variableName),
		},
	})
}

// 添加@(modelName)
func (ctl *Controller) Create@(modelName)(c *gin.Context) {
    var param @httpPackage.@(modelName)Param
    if err := c.ShouldBindJSON(&param); err != nil {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    user := ctl.GetLoginUser(c)
    @(variableName), err := ctl.Service.Create@(modelName)(&param, user)
    if err != nil {
        c.Error(err)
        return
    }
    c.JSON(http.StatusOK, &@(httpPackage).BaseResp{
        Meta: &@(httpPackage).Meta{
            Code: @(errorPackage).CodeSuccess,
        },
        Data: struct {
            @(modelName) *@(beanPackage).@(modelName) `json:"@variableName"`
        }{
            @(modelName): @(variableName),
        },
    })
}

// 更新@(modelName)
func (ctl *Controller) Update@(modelName)(c *gin.Context) {
    idString := c.Param("@(variableName)_id")
    if idString == "" {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    id, err := strconv.ParseUint(idString, 10, 64)
    if err != nil {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    var param @httpPackage.@(modelName)Param
    if err := c.ShouldBindJSON(&param); err != nil {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    user := ctl.GetLoginUser(c)
    @(variableName), err := ctl.Service.Update@(modelName)(id, &param, user)
    if err != nil {
        c.Error(err)
        return
    }

    c.JSON(http.StatusOK, &@(httpPackage).BaseResp{
        Meta: &@(httpPackage).Meta{
            Code: @(errorPackage).CodeSuccess,
        },
        Data: struct {
            @(modelName) *@(beanPackage).@(modelName)
        }{
            @(modelName): @(variableName),
        },
    })
}

// 删除@(modelName)
func (ctl *Controller) Delete@(modelName)(c *gin.Context) {
    idString := c.Param("@(variableName)_id")
    if idString == "" {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    id, err := strconv.ParseUint(idString, 10, 64)
    if err != nil {
        c.Error(&@(errorPackage).Error{Code: @(errorPackage).RequestParameterInvalid})
        return
    }
    user := ctl.GetLoginUser(c)
    @(variableName), err := ctl.Service.Delete@(modelName)(id, user.ID)
    if err != nil {
        c.Error(err)
        return
    }
    c.JSON(http.StatusOK, &@(httpPackage).BaseResp{
        Meta: &@(httpPackage).Meta{
            Code: @(errorPackage).CodeSuccess,
        },
        Data: struct {
            @(modelName) *@(beanPackage).@(modelName)
        }{
            @(modelName): @(variableName),
        },
    })
}

